{% extends "base.html" %}

{% block title %}New Deposit - Investment Platform{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Make a New Deposit</h3>
            </div>
            <div class="card-body">
                <form method="POST">

                    <div class="mb-3 text-center">
                        <label class="form-label">Scan to Pay (UPI QR)</label>
                        <div>
                            <img id="qrCode" src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=9294609146@ibl" alt="UPI QR Code" style="margin-bottom:10px;" />
                        </div>
                        <div>
                            <strong>UPI ID:</strong> 8789293780@ybl
                        </div>
                        <div id="qr-timer" class="mt-2 text-danger fw-bold"></div>
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount (₹)</label>
                        <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="100" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duration (Days)</label>
                        <input type="number" class="form-control" id="duration_days" name="duration_days" min="1" max="3650" step="1" value="1" required placeholder="Enter duration in days">
                    </div>
                    <div class="alert alert-info" id="returnInfo">
                        {% set settings = settings or {} %}
                        {% set current_rate = settings.get('interest_rate', 8.0) %}
                        Based on the <strong>current interest rate</strong> of <span id="interestRate">{{ current_rate }}</span>%, your expected return will be: ₹<span id="expectedReturn">0.00</span>
                        <br>
                        <small class="text-muted">Note: This rate applies only to this new deposit. Previous investments keep their original rate.</small>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Continue to Upload Proof</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function calculateReturn() {
    const amount = parseFloat(document.getElementById('amount').value) || 0;
    const days = parseInt(document.getElementById('duration_days').value) || 0;
    const rate = parseFloat(document.getElementById('interestRate').textContent);
    const expectedReturn = (amount * rate * (days/365)) / 100;
    document.getElementById('expectedReturn').textContent = expectedReturn.toFixed(2);
}

// Timer for QR code
let qrSeconds = 300; // 5 minutes
const qrTimerDiv = document.getElementById('qr-timer');
function updateQrTimer() {
    const min = Math.floor(qrSeconds / 60);
    const sec = qrSeconds % 60;
    qrTimerDiv.textContent = `QR valid for: ${min}:${sec.toString().padStart(2, '0')}`;
    if (qrSeconds > 0) {
        qrSeconds--;
        setTimeout(updateQrTimer, 1000);
    } else {
        qrTimerDiv.textContent = 'QR expired. Refresh page to get a new code.';
        document.getElementById('qrCode').style.opacity = 0.5;
    }
}
updateQrTimer();

document.getElementById('amount').addEventListener('input', calculateReturn);
document.getElementById('duration_days').addEventListener('input', calculateReturn);
</script>
{% endblock %}
